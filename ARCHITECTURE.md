# Architecture

This project is built using [**Fresh**](https://fresh.deno.dev/), a web
framework for Deno focused on fast, island-based rendering. It uses **Deno
Deploy** for hosting and **Deno KV** for data persistence. The project scrapes
and processes events from [ocparks.com/events](https://ocparks.com/events),
applies machine-learned tags via a Python
[microservice](https://karni.codes/events-tagger), and displays everything in a
searchable, filterable UI.

## `components/`

The components folder is used to define any global UI components used across the
site. This folder was not used enough and can be refactored to update and
include button elements.

- `Footer.tsx` Footer displayed at the bottom of the page.
- `Navbar.tsx` Simple Navbar displayed at the top of the page.

## `islands/`

Deno Fresh "islands" are interactive components hydrated on the client side only
when needed. This helps prevent the use of JavaScript throughout the website and
contains it to specific elements. (However, if JS is disabled, the website does
not run.)

- `EventList.tsx` Handles displaying, filtering, and toggling event cards based
  on selected tags.
- `ScrollToTop.tsx` Adds scroll-to-top behavior for infinite scroll (Pagination
  was complex, but can be implemented later).

## `routes/`

The routes directory is where all the website's pages and API endpoints are
defined. This is the core structure of the website's navigation, server
behavior, and delivery of static and dynamic content.

- `index.tsx` Homepage of the site, contains all components and event cards.
- `_app.tsx` Global layout wrapper.
- `_404.tsx` Custom 404 page.
- `api/data.ts` Direct pull of event data from the source website.
- `api/events.ts` Serves paginated and optionally tag-filtered event data from
  Deno KV, fetching and caching data via fetchEvents() only when the KV store is
  empty.

## `utils/`

Utils contains core utility logic that supports the backend functionality of the
site. The primary function of the backend is to clean the fetched data and
populate the KV database.

- `events.ts` Scraper/parser that gathers and caches events in KV.
- `links.ts` Fetches extra details (image, description, location) from
  individual event pages using **deno_dom**.
- `types.ts` Type definitions shared across components and routes.
- `update_events.ts` Used to trigger scraping and updating the KV in production,
  on an HOURLY schedule (defined in `deno.json`).

## `static/`

Assets (such as progress pictures, icons, favicons) are all stored in here.
Styling for components and the main homepage are also found in here through
`styles.css`.

## Root Files

| File              | Description                                     |
| ----------------- | ----------------------------------------------- |
| `deno.json`       | Deno configuration: tasks, imports, lint rules. |
| `fresh.config.ts` | Fresh-specific configuration.                   |
| `fresh.gen.ts`    | Auto-generated by Fresh. Do not edit.           |
| `main.ts`         | Entry point for server-side app.                |
| `clean_kv.ts`     | Script to remove or reset data in Deno KV.      |
| `print_kv.ts`     | Script to inspect what's currently in KV.       |
| `CONTRIBUTING.md` | Guide for contributors.                         |
| `LICENSE`         | Project license.                                |

## External Python Tagging API

A separate Python project
([not in this repo](https://karni.codes/events-tagger)) uses **scikit-learn** to
generate semantic tags from event descriptions. This API:

- Accepts POSTed JSON descriptions
- Returns an array of string tags
- Helps categorize and enrich event metadata for filtering in the frontend

## Deno KV Usage

All parsed event data is stored in **Deno KV** under a prefix like
`["events", "item", <eventId>]`.

- The `events.ts` file in `/utils` fetches, parses, and inserts new or updated
  entries.
- The `/api/events` route reads from KV, applies filters, and returns paginated
  responses.

## Tasks & Scripts

Define and run tasks using Denoâ€™s task runner (via `deno.json`):

```bash
deno task update_events   # updates prod database (requires env)
deno task start           # starts local dev server
```
